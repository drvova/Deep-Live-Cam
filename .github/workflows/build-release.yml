name: Build Release (Optimized)

on:
    push:
        tags:
            - "v*"
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:
        inputs:
            build_windows:
                description: "Build Windows executable"
                required: true
                default: true
                type: boolean
            build_linux:
                description: "Build Linux executable"
                required: true
                default: false
                type: boolean

env:
  PYTHON_VERSION: "3.10"
  MODELS_KEY: "models-v1"  # Update when models change

jobs:
    build-windows:
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.build_windows }}
        runs-on: windows-latest
        timeout-minutes: 45

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Set Up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Cache AI Models
              uses: actions/cache@v4
              id: model-cache
              with:
                  path: models/
                  key: ${{ env.MODELS_KEY }}-${{ runner.os }}
                  restore-keys: |
                      ${{ env.MODELS_KEY }}-

            - name: Download Models
              if: steps.model-cache.outputs.cache-hit != 'true'
              run: |
                  mkdir -p models
                  echo "Downloading models..."
                  curl -L -o models/inswapper_128_fp16.onnx "https://huggingface.co/hacksider/deep-live-cam/resolve/main/inswapper_128_fp16.onnx?download=true"
                  curl -L -o models/GFPGANv1.4.pth "https://github.com/TencentARC/GFPGAN/releases/download/v1.3.4/GFPGANv1.4.pth"
              shell: bash

            - name: Cache Pip Dependencies
              uses: actions/cache@v4
              id: pip-cache
              with:
                  path: ~\AppData\Local\pip\Cache
                  key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'build/requirements-windows.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install -r build/requirements-windows.txt
                  pip install "pyinstaller>=6.0.0"
              shell: pwsh

            - name: Install UPX
              run: |
                  $upxUrl = "https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip"
                  $upxZip = "$env:TEMP\upx.zip"
                  Invoke-WebRequest -Uri $upxUrl -OutFile $upxZip
                  Expand-Archive -Path $upxZip -DestinationPath "$env:TEMP\upx" -Force
                  $upxPath = "$env:TEMP\upx\upx-4.2.4-win64\upx.exe"
                  echo "$upxPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              shell: pwsh

            - name: Build Windows Executable
              run: |
                  python build/build.py --mode onedir --no-console --upx
              shell: pwsh

            - name: Verify Build
              run: |
                  dir dist\Deep-Live-Cam
                  dist\Deep-Live-Cam\Deep-Live-Cam.exe --version
              shell: cmd

            - name: Create ZIP Archive
              run: |
                  Compress-Archive -Path dist\Deep-Live-Cam\* -DestinationPath Deep-Live-Cam-Windows-x64.zip
              shell: pwsh

            - name: Upload Windows Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: Deep-Live-Cam-Windows-x64
                  path: Deep-Live-Cam-Windows-x64.zip
                  retention-days: 30

    build-linux:
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.build_linux }}
        runs-on: ubuntu-22.04
        timeout-minutes: 45

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Set Up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: "pip"

            - name: Cache AI Models
              uses: actions/cache@v4
              id: model-cache
              with:
                  path: models/
                  key: ${{ env.MODELS_KEY }}-${{ runner.os }}
                  restore-keys: |
                      ${{ env.MODELS_KEY }}-

            - name: Download Models
              if: steps.model-cache.outputs.cache-hit != 'true'
              run: |
                  mkdir -p models
                  echo "Downloading models..."
                  curl -L -o models/inswapper_128_fp16.onnx "https://huggingface.co/hacksider/deep-live-cam/resolve/main/inswapper_128_fp16.onnx?download=true"
                  curl -L -o models/GFPGANv1.4.pth "https://github.com/TencentARC/GFPGAN/releases/download/v1.3.4/GFPGANv1.4.pth"

            - name: Cache APT Packages
              uses: actions/cache@v4
              id: apt-cache
              with:
                  path: /var/cache/apt/archives
                  key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/build-release-optimized.yml') }}

            - name: Install System Dependencies
              if: steps.apt-cache.outputs.cache-hit != 'true'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y python3-tk

            - name: Install System Dependencies (From Cache)
              if: steps.apt-cache.outputs.cache-hit == 'true'
              run: |
                  sudo apt-get install -y python3-tk

            - name: Cache Pip Dependencies
              uses: actions/cache@v4
              id: pip-cache
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install "pyinstaller>=6.0.0"

            - name: Install UPX
              run: |
                  wget -q https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-amd64_linux.tar.xz
                  tar -xf upx-4.2.4-amd64_linux.tar.xz
                  sudo cp upx-4.2.4-amd64_linux/upx /usr/local/bin/
                  upx --version

            - name: Build Linux Executable
              run: |
                  python build/build.py --mode onedir --no-console --upx

            - name: Verify Build
              run: |
                  ls -lh dist/Deep-Live-Cam/
                  ./dist/Deep-Live-Cam/Deep-Live-Cam --version

            - name: Create Tarball
              run: |
                  cd dist
                  tar -czvf ../Deep-Live-Cam-Linux-x64.tar.gz Deep-Live-Cam/

            - name: Upload Linux Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: Deep-Live-Cam-Linux-x64
                  path: Deep-Live-Cam-Linux-x64.tar.gz
                  retention-days: 30

    release:
        needs: [build-windows, build-linux]
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Download All Artifacts
              uses: actions/download-artifact@v4

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      Deep-Live-Cam-Windows-x64/Deep-Live-Cam-Windows-x64.zip
                      Deep-Live-Cam-Linux-x64/Deep-Live-Cam-Linux-x64.tar.gz
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
